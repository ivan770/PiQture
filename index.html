<head>
<title>PiQture</title>
<link href="style.css" rel="stylesheet" type="text/css">
</head>

<div class="container">

  <div class="demo-flex-spacer"></div>

  <div class="webflow-style-input">
    <input class="" type="text" placeholder="PiQture 0.9" id="screenshot-path"></input>
    <button id="screenshot"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABTSURBVDhPY6A14AdiHQiTPNAPxG+B2AjMIwNwAfEBIB4chuwHYtoZkgfEq4jAW4D4PxCDDDEAYjig2ABiAEXhQLFmsqORIs0gQHFSpjgzEQAMDABVMCWHZbRzNwAAAABJRU5ErkJggg=="></button>
  </div>

  <div class="demo-flex-spacer"></div>
  <a id="close" onclick="hide()" title="PiQture will hide automatically after capturing">Hide PiQture to tray</a>


</div>
<script src="js/time.js"></script>
<script>
const electron = require('electron')
const desktopCapturer = electron.desktopCapturer
const electronScreen = electron.screen
const shell = electron.shell
const remote = electron.remote
const {Tray, Menu} = remote
const {clipboard} = require('electron')

const fs = require('fs')
const os = require('os')
const path = require('path')

const screenshot = document.getElementById('screenshot')
const screenshotMsg = document.getElementById('screenshot-path')
const windowSecond = remote.getCurrentWindow()
const ipc = require('electron').ipcRenderer

screenshot.addEventListener('click', function (event) {
  ipc.send('save-dialog')
  ipc.on('saved-file', function (event, pathFile) {
  if (!pathFile) pathFile = 'Clipboard'
  screenshotMsg.placeholder = `Path selected: ${pathFile}`
  start(pathFile)
})
})

function determineScreenShotSize () {
  const screenSize = electronScreen.getPrimaryDisplay().workAreaSize
  const maxDimension = Math.max(screenSize.width, screenSize.height)
  return {
    width: maxDimension * window.devicePixelRatio,
    height: maxDimension * window.devicePixelRatio
  }
}

function start(pathFile){
  windowSecond.hide();
  setTimeout(func, 1000);
  function func(){
  screenshotMsg.placeholder = 'Gathering screens...'
  const thumbSize = determineScreenShotSize()
  let options = { types: ['screen'], thumbnailSize: thumbSize }

  desktopCapturer.getSources(options, function (error, sources) {
    if (error) return console.log(error)

    sources.forEach(function (source) {
      if (source.name === 'Entire screen' || source.name === 'Screen 1') {
        const screenshotPath = path.join(pathFile)

        fs.writeFile(screenshotPath, source.thumbnail.toPng(), function (error) {
          if (error) return console.log(error)
          // shell.openExternal('file://' + screenshotPath) -- Open photo
          shell.showItemInFolder('file://' + screenshotPath)
          const message = `Saved screenshot to: ${screenshotPath}`
          screenshotMsg.placeholder = message
          clipboard.clear();
          clipboard.writeImage(source.thumbnail)
        })
      }
    })
  })
}
}

function hide(){
  windowSecond.hide();
}

function show(){
  windowSecond.show();
}

function exit(){
  windowSecond.close();
}

ipc.on('shortcut-screenshot', function (event) {
start(path.join(os.homedir(), piqture_time()+".png"))
})

document.addEventListener("keydown", function (e) {
    if (e.which === 123) {
        ipc.send('developer')
      }
    });
</script>
<script src="js/tray.js"></script>
